import React, { useState, useCallback } from 'react'
import Dialog, { withLazy } from '@/components/Dialog'
import { Input, Form, Row, Col, Upload, Icon, Radio, Button, TreeSelect, message } from 'antd'
import './index.less'
import fetch from '@/services/axios';

import { get, omit, isFunction } from 'lodash'
const radioOptions = [
  { label: '男', value: '男' },
  { label: '女', value: '女' }
]
const { SHOW_CHILD, TreeNode } = TreeSelect

const Label = ({ title, children }) => { // 菜单
  return (
    <Form.Item className="examinee-page-add-examinee-label">
      <label className="examinee-page-add-examinee-label-item">{title}</label>
      <span className="examinee-page-add-examinee-label-span">{children}</span>
    </Form.Item>
  )
}
//重置

const WrapForm = props => {
  const { examSiteSelectData, onReload, API, onCancel } = props
  const { getFieldDecorator, resetFields, validateFields } = props.form
  const [imageUrl, setImageUrl] = useState(null)
  const loading = false
  const [fileList, setFileList] = useState([])
  const tProps = {
    showCheckedStrategy: SHOW_CHILD,
    searchPlaceholder: '请输入考生座位',
    treeCheckable: true,
    style: {
      width: '100%',
    },
  };
  console.log(props)
  // 参数 name examNumberId
  const childrenTree = (childrenItem, index) => (
    <TreeNode value={
      `${childrenItem.examNumberId}&&${childrenItem.name}&&${childrenItem.subject}`
    } title={childrenItem.name + '-' + childrenItem.subject} key={childrenItem.examNumberId} />)
  function beforeUpload(file) { //判断是否上传
    return false;
  }


  const requsetAddExaminee = param => { // 添加考生
    try {
      fetch.post(API, param).then(res => {
        if (get(res, 'state') === 10000) {
          message.success(res.message, 1).then(() => {
            onCancel(); //关闭
            isFunction(onReload) && onReload()
            reset()
          });
        } else if (get(res, 'state') === -1) {
          message.error(res.message)
        }
      })
    } catch (err) {
      console.log('报错', err)
    }
  }

  const handleSubmit = e => {
    e.preventDefault()
    // console.log(props)
    validateFields((err, values) => {
      if (!err) {
        if(fileList.length === 0) {
          message.info('请先上传照片')
          return 
        }
        let valueObj = { ...values, headPhoto: fileList[0] } // 照片合并
        //  console.log(valueObj)
        let { examNumberBrief } = valueObj
        let param = []
        param = examNumberBrief.map((item, index) => { // java 要的格式
          let examNumberId = `examNumberBrief[${index}].examNumberId`
          let examNumberName = `examNumberBrief[${index}].examNumberName`
          let subject = `examNumberBrief[${index}].subject`
          let itemSplit = item.split('&&')
          valueObj[examNumberId] = itemSplit[0] || ''
          valueObj[examNumberName] = itemSplit[1] || ''
          valueObj[subject] = itemSplit[2] || ''
        })
        let examineeInfo = omit(valueObj, 'examNumberBrief')  //删除字段
        let formData = new FormData()
        for (let itemKey in examineeInfo) {
          formData.append([itemKey], examineeInfo[itemKey])
        }
        requsetAddExaminee(formData)
      }
    })
  }

  const reset = e => {
    resetFields(['examineeId', 'seatNo', 'sex', 'examNumberBrief', 'name', 'idCard', 'phone'])
    setImageUrl(null)
    setFileList([])
  }

  const handleChange = useCallback(
    (fileObject) => {
      let reader = new FileReader()
      reader.readAsDataURL(fileObject.file)
      reader.onload = () => {
        setImageUrl(reader.result)
      }
      // console.log(fileObject.file)
      setFileList([fileObject.file])
      // setImageUrl()   
    }, [imageUrl])
  return (
    <Form className="examinee-page-add-examinee" onSubmit={handleSubmit}>
      <Row gutter={[12]}>
        <Col span={8} push={2}>
          <Upload
            name="avatar"
            fileList={fileList}
            listType="picture-card"
            className="avatar-uploader"
            showUploadList={false}
            beforeUpload={beforeUpload}
            onChange={handleChange}
          >
            {imageUrl ? <img src={imageUrl} alt="avatar" style={{ width: '100%' }} /> : <Icon type={loading ? 'loading' : 'plus'} />
            }
          </Upload>
        </Col>
        <Col span={8}>
          <Label title="考生编号：">
            {getFieldDecorator('examineeId', {
              initialValue: '',
              rules: [
                {
                  required: true,
                  message: '请输入考生编号'
                }]

            })(<Input />)}
          </Label>
          <Label title="考生座位：">
            {getFieldDecorator('seatNo', {
              initialValue: '',
              rules: [
                {
                  required: true,
                  message: '请输入考生座位'
                }]

            })(<Input />)}
          </Label>
          <Label title="考生性别：">
            {getFieldDecorator('sex', { initialValue: '', 
            rules: [
                {
                  required: true,
                  message: '请输入考生性别'
                }]
             })(<Radio.Group options={radioOptions} />)}
          </Label>
          <Label title="考场教室 ：">
            {getFieldDecorator('examNumberBrief', {
              rules: [
                {
                  required: true,
                  message: '请输入考场教室'
                }]

            })(
              (
                <TreeSelect
                  {...tProps}
                >
                  {!!examSiteSelectData.length && examSiteSelectData.map(item => (
                    <TreeNode value={item.siteName} title={item.siteName} key={item.siteId}>
                      {
                        !! !!item.examNumber && !!item.examNumber.length && item.examNumber.map((childrenItem, index) => {
                          return childrenTree(childrenItem, index)
                        })
                      }
                    </TreeNode>
                  ))}
                </TreeSelect>
              )
            )}
          </Label>
        </Col>
        <Col span={8}>
          <Label title="考生姓名:">
            {getFieldDecorator('name', {
              initialValue: '', rules: [
                {
                  required: true,
                  message: '请输入考场姓名'
                }]
            })(<Input />)}
          </Label>
          <Label title="身份证： ">
            {getFieldDecorator('idCard', {
              initialValue: '',
              rules: [
                {
                  required: true,
                  message: '请输入身份证'
                }]
            })(<Input />)}
          </Label>
          <Label title="手机号： ">
            {getFieldDecorator('phone', {
              initialValue: '',
              rules: [
                {
                  required: true,
                  message: '请输入手机号'
                }]
            })(<Input />)}
          </Label>
        </Col>
      </Row>
      <hr />
      <Row justify="center" type="flex">
        <Col span={3}>
          <Button type="primary" htmlType="submit">
            添加
          </Button>
        </Col>
        <Col span={3}>
          <Button type="danger" onClick={reset}>
            重置
          </Button>
        </Col>
      </Row>
    </Form>
  )
}

const Wrap = Form.create()(WrapForm)
function AddExaminee(props) {
  return (
    <Dialog title="添加考生" {...props} footer={null}>
    
      <Wrap {...props} />
    </Dialog>
  )
}
AddExaminee.defaultProps = {
  width: "900px"
}
export default withLazy(AddExaminee)