import React, { useState, useEffect, createContext } from 'react'
import { get } from 'lodash'
import fetch from '@/services/axios';
import HeaderSearch from './components/HeaderSearch'
import CardContent from './components/CardContent'
import Export from './components/Export'
import { GATE_LIST_API, CARD_LIST_API, POINT_LIST_API, NUMBER_LIST_API, CARD_DATA_LIST_API } from './apis'
import { Button, Pagination } from 'antd'

const mydate = Date.parse(new Date())
const bTime = (new Date(new Date(mydate).getTime()).setHours(0, 0, 0, 0)) / 1000//开始时间
const eTime = (new Date(new Date(mydate).getTime()).setHours(24, 0, 0, 0)) / 1000//结束时间

export const CardContext = createContext({})

export default Current => {
    const [GateList, setGateList] = useState([])//设备下拉数据
    // const [CardList, setCardList] = useState([])//
    const [point, setPoint] = useState([])//考点下拉
    const [number, setNumber] = useState([])//考场下拉
    const [DataInfo, setDataInfo] = useState([])//获取数据
    const [pagination, setPagination] = useState([])//分页数据
    const [paramer, setParamer] = useState([])//查询参数
    const [cardData, setCardData] = useState({//默认当天参数
        "beginTime": bTime,
        "endTime": eTime,
        // "beginTime": 1584547200,
        // "endTime": 1584633599,
        "pageNumber": "1",
        "pageSize": "4",
    })
    // 获取下拉列表
    const getGateList = () => {
        fetch.get(GATE_LIST_API).then(res => {
            if (get(res, 'state') === 10000) {
                // console.log('res',res.data)
                setGateList(res.data)
            }
        })
    }

    useEffect(() => {
        getGateList()
    }, [])

    // 获取mock数据
    // const getCardList = () => {
    //     fetch.get(CARD_LIST_API).then(res => {
    //         //   console.log('拿到的数据',res.data.data)
    //         setCardList(res.data.data)
    //     })
    // }
    // useEffect(() => {
    //     getCardList()
    // }, [])
    //考点
    const getPoint = () => {
        fetch.post(POINT_LIST_API).then(res => {
            // console.log('考点',res.data)
            if (get(res, 'state') === 10000) {
                setPoint(res.data)
            }

        })
    }
    useEffect(() => {
        getPoint()
    }, [])

    const getNumber = (id) => {//获取考场下拉列表
        let params = { siteId: id }
        fetch.post(NUMBER_LIST_API, params).then(res => {
            // console.log('拿到的考场数据', res.data)
            if (get(res, 'state') === 10000) {
                setNumber(res.data)
            }
        })
    }
    useEffect(() => {
        getNumber()
    }, [])


    //导出数据
    const handleOK = (value) => {
        console.log('拿到的什么',value)
        window.location.href = '/yzSmartGate/manage/examPassthrough/exportAttendance?siteId=' + value.siteId + '&examNumberId=' + value.examNumberId
    }
    //根据条件查询
    const onHandleSearch = valueObj => {
        let params = valueObj
        let defaultPragrams = {
            // "beginTime": mydate,
            // "endTime": mydate,
            "pageNumber": "1",
            "pageSize": "4",
        }
        params.beginTime = (new Date(new Date(valueObj.beginTime).getTime())) / 1000
        // 结束时间
        params.endTime = (new Date(new Date(valueObj.endTime).getTime())) / 1000

        params = Object.assign(defaultPragrams, params)
        console.log('最后的参数', params)    
        getCardData(params)//请求数据
        setParamer(params)//保存参数
    }

    const getCardData = (param) => {//获取当天时间的数据
        fetch.post(CARD_DATA_LIST_API, param).then(res => {
            console.log('cardLIst', res)
            if (get(res, 'state') === 10000) {
                setDataInfo(res.data.content)
                setPagination(res.data)
                // console.log('addd', pagination)
            }
        })
    }
    useEffect(() => {
        getCardData(cardData)
    },[])

    const onChange = (current) => {
        //    console.log(current)
        //    let params =  cardData
        let params = paramer
        params.pageNumber = current
        console.log('params', params)
        getCardData(params)
    }


    return (
        <section className="current-page">
            <section className="current-page-list">
                <section className="current-page-list-operation">
                    <HeaderSearch GateList={GateList} onHandleSearch={onHandleSearch} />
                </section>
                <section className="current-page-list-button" style={{ marginTop: "10px" }}>
                    <Export point={point} getNumber={getNumber} number={number} footer={null} handleOK={handleOK}>
                        <Button type="primary">数据导出</Button>
                    </Export>
                </section>
                <section className="current-page-list-content">
                    <CardContext.Provider value={DataInfo}>
                        <CardContent />
                    </CardContext.Provider>
                    <section className="current-page-list-content-pagination" style={{ marginTop: "10px", float: "right" }}>
                        <Pagination
                            onChange={onChange}
                            total={pagination&&pagination.totalElements}
                            showTotal={total => `总共有 ${total} 条记录`}
                            pageSize={pagination&&pagination.size}
                            defaultCurrent={1}
                        />
                    </section>
                    <section>
                    </section>
                </section>
            </section>
        </section>
    )
}