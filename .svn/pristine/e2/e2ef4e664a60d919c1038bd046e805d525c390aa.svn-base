import React, { useState, useEffect } from 'react'
import { get } from 'lodash'
import fetch from '@/services/axios';
import HeaderSearch from './components/HeaderSearch'
import CardContent from './components/CardContent'
import ModalData from './components/ExportData'
// import Export from './components/Export'
import { GATE_LIST_API, POINT_LIST_API, NUMBER_LIST_API, CARD_DATA_LIST_API } from './apis'
import { Button, Pagination, Modal } from 'antd'
import './index.less'


const mydate = Date.parse(new Date())
const bTime = (new Date(new Date(mydate).getTime()).setHours(0, 0, 0, 0)) / 1000//开始时间
const eTime = (new Date(new Date(mydate).getTime()).setHours(24, 0, 0, 0)) / 1000//结束时间

// export const CardContext = createContext({})

const Current = () => {
  const [GateList, setGateList] = useState([])//设备下拉数据
  const [point, setPoint] = useState([])//考点下拉
  const [number, setNumber] = useState([])//考场下拉
  const [DataInfo, setDataInfo] = useState([])//获取数据
  const [paginations, setPagination] = useState([])//分页数据
  // const [paramer, setParamer] = useState([])//查询参数
  const [visible, setVisible] = useState(false)
  const [cardData, setCardData] = useState({//默认当天参数
    "beginTime": bTime,
    "endTime": eTime,
    // "beginTime": 1584460800,
    // "endTime": 1586275199,
    "pageNumber": "1",
    "pageSize": "32",
  })
  // 获取下拉列表
  const getGateList = () => {
    fetch.get(GATE_LIST_API).then(res => {
      if (get(res, 'state') === 10000) {
        // console.log('res',res.data)
        setGateList(res.data)
      }
    })
  }

  //考点
  const getPoint = () => {
    fetch.post(POINT_LIST_API).then(res => {
      // console.log('考点',res.data)
      if (get(res, 'state') === 10000) {
        setPoint(res.data)
      }
    })
  }

  const getNumber = (id) => {//获取考场下拉列表
    let params = { siteId: id }
    fetch.post(NUMBER_LIST_API, params).then(res => {
      // console.log('拿到的考场数据', res.data)
      if (get(res, 'state') === 10000) {
        setNumber(res.data)
      }
    })
  }

  const exportData = () => {//打开数据导出模太框
    setVisible(true)
  }
  const handleCancel = () => {//关闭数据导出模太框
    setVisible(false)
  }
  //导出数据
  const handleOK = (value) => {
    // console.log('拿到的什么', value)
    window.location.href = '/yzSmartGate/manage/examPassthrough/exportAttendance?siteId=' + value.siteId + '&examNumberId=' + value.examNumberId
    setVisible(false)
  }
  //根据条件查询
  const onHandleSearch = valueObj => {
    let params = valueObj
    let defaultPragrams = {
      // "beginTime": mydate,
      // "endTime": mydate,
      "pageNumber": "1",
      "pageSize": "32",
    }
    params.beginTime = (new Date(new Date(valueObj.beginTime).getTime())) / 1000//开始时间
    params.endTime = (new Date(new Date(valueObj.endTime).getTime())) / 1000//结束时间
    params = Object.assign(defaultPragrams, params)//合并参数
    // console.log('最后的参数', params)
    getCardData(params)//请求数据
    // setParamer(params)//保存参数
    setCardData(params)//保存参数
  }

  const getCardData = (param) => {//获取当天时间的数据
    fetch.post(CARD_DATA_LIST_API, param).then(res => {
      // console.log('cardLIst', res)
      if (get(res, 'state') === 10000) {
        setDataInfo(res.data.content)
        setPagination(res.data)
      }
    })
  }
  useEffect(() => {
    getGateList()
    getPoint()
    getNumber()
    getCardData(cardData)
  }, [])

  const onChange = (current) => {
    //  console.log(current)
    let params = cardData
    // let params = paramer
    params.pageNumber = current
    getCardData(params)
  }

  return (
    <section className="current-page">
      <section className="current-page-list">
        <section className="current-page-list-operation">
          <HeaderSearch GateList={GateList} onHandleSearch={onHandleSearch} />
        </section>
        <section className="current-page-list-button">
          {/* <Export point={point} getNumber={getNumber} number={number}  handleOK={handleOK} footer={null}> */}
          <Button type="primary" onClick={() => exportData()}>数据导出</Button>
          {/* </Export> */}
          <Modal
            title="数据导出"
            visible={visible}
            onCancel={handleCancel}
            footer={null}
            width="500px"
          >
            <ModalData point={point} getNumber={getNumber} number={number} handleOK={handleOK} />
          </Modal>
        </section>
        <section className="current-page-list-content">
          {/* <CardContext.Provider value={DataInfo}> */}
            <CardContent DataInfo={DataInfo}/>
          {/* </CardContext.Provider> */}
          <section className="current-page-list-content-pagination" >
            <Pagination
              onChange={onChange}
              total={paginations&&paginations.totalElements}
              showTotal={total => `总共有 ${total} 条记录`}
              pageSize={+cardData.pageSize}
              // current={paginations.pageNumber + 1}
              defaultCurrent={1}
            /> 
          </section>
          <section>
          </section>
        </section>
      </section>
    </section>
  )
}

export default Current